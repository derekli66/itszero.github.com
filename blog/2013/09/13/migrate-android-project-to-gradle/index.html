
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Migrate Android Project to Gradle Build System - [Zero setLogger: self];</title>
  <meta name="author" content="Zero Cho">

  
  <meta name="description" content="Gradle is a new build system that Android is currently promoting. It can be
used to build Android project by adding a Gradle Android plugin. It is &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://itszero.github.com/blog/2013/09/13/migrate-android-project-to-gradle/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="[Zero setLogger: self];" type="application/atom+xml">
</head>

<body >
  <div id="main">
    <aside class="site-nav">
      <a href="/">
        <div class="logo">Z</div>
        <div class="logo-text">ero</div>
      </a>
      <ul>
        <a href="/"><li class="link-blog">blog</li></a>
        <a href="/resume"><li class="link-resume">resume</li></a>
        <a href="/portfolio"><li class="link-portfolio">portfolio</li></a>
        <a href="/about"><li class="link-contact">about</li></a>
      </ul>
    </aside>
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <p class="meta">
        








  


<time datetime="2013-09-13T13:57:00-04:00" pubdate data-updated="true">Sep 13<span>th</span>, 2013</time> | 

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/gradle/'>gradle</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title">Migrate Android Project to Gradle Build System</h1>
    
  </header>


<div class="entry-content"><p><a href="http://www.gradle.org/">Gradle</a> is a new build system that Android is currently promoting. It can be
used to build Android project by adding a <a href="http://tools.android.com/tech-docs/new-build-system/user-guide">Gradle Android plugin</a>. It is also
possible that Android would move to Gradle-only build system, ditching the old
ant-way to build things. The <a href="http://developer.android.com/sdk/installing/studio.html">Android Studio</a> only supports Gradle projects.</p>

<h2>Quickstart</h2>

<p>To join the new family, we need to write a new build.gradle file in project
root. An general example of build.gradle would look like the snippet below.
Please note that the system is still in active development, version numbers
could change very soon. I&rsquo;m using Gradle 1.7, plugin 0.5.6, Android Build Tools
17 and my target SDK version is 15.</p>

<figure class='code'><figcaption><span>A simple build.gradle for Android project</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">buildscript</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">repositories</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mavenCentral</span><span class="o">()</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">classpath</span> <span class="s1">&#39;com.android.tools.build:gradle:0.5.6&#39;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">&#39;android&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">compileSdkVersion</span> <span class="mi">15</span>
</span><span class='line'>  <span class="n">buildToolsVersion</span> <span class="s2">&quot;17&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sourceSets</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">main</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">manifest</span><span class="o">.</span><span class="na">srcFile</span> <span class="s1">&#39;AndroidManifest.xml&#39;</span>
</span><span class='line'>        <span class="n">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;src&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">res</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;res&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simple gradle file should be able to build most of standard Android
projects. But what if I have special need? I&rsquo;m going to talk about how to
add support for AndroidAnnotation and token replacement below.</p>

<h3>Android Annotation</h3>

<p><a href="https://github.com/excilys/androidannotations">AndroidAnnotation</a> is a set of very useful annotations that you could use in
your code to make your code shorter and more easier to read. The framework
utilize a annotation processor to scan through your source code file and
generate helper classes. To integrate it, we need to do 2 things:</p>

<ul>
<li>Add processor flags to Java compiler</li>
<li>Add androidannotation-api dependency</li>
</ul>


<h4>Manipulating Compile Task</h4>

<p>To add extra flags to compiler, we need to use the interface Android Gradle
plugin exposed to access relevant tasks. The build plugin organize tasks into
different &ldquo;variants&rdquo;, some basic variants includes debug and release. To
iterate through all variants, we could use <code>android.applicationVariants.all</code>.</p>

<figure class='code'><figcaption><span>Add support of Android annotation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="c1">// Code based on https://github.com/excilys/androidannotations/issues/676</span>
</span><span class='line'><span class="kt">def</span> <span class="nf">getSourceSetName</span><span class="o">(</span><span class="n">variant</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">variant</span><span class="o">.</span><span class="na">dirName</span><span class="o">).</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span><span class="o">.</span><span class="na">applicationVariants</span><span class="o">.</span><span class="na">all</span> <span class="o">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="n">aptOutputDir</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="s2">&quot;build/source/apt&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kt">def</span> <span class="n">aptOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">aptOutputDir</span><span class="o">,</span> <span class="n">variant</span><span class="o">.</span><span class="na">dirName</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">android</span><span class="o">.</span><span class="na">sourceSets</span><span class="o">[</span><span class="n">getSourceSetName</span><span class="o">(</span><span class="n">variant</span><span class="o">)].</span><span class="na">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="n">aptOutput</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">options</span><span class="o">.</span><span class="na">compilerArgs</span> <span class="o">+=</span> <span class="o">[</span>
</span><span class='line'>    <span class="s1">&#39;-processorpath&#39;</span><span class="o">,</span> <span class="n">configurations</span><span class="o">.</span><span class="na">apt</span><span class="o">.</span><span class="na">getAsPath</span><span class="o">(),</span>
</span><span class='line'>    <span class="s1">&#39;-s&#39;</span><span class="o">,</span> <span class="n">aptOutput</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">source</span><span class="o">.</span><span class="na">filter</span> <span class="o">{</span> <span class="n">p</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">aptOutputDir</span><span class="o">.</span><span class="na">getPath</span><span class="o">())</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">doFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">aptOutput</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">()</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>configurations.apt</code> is missing at the moment. We used the variable to
store path to Android Annotation processor and we use Gradle&rsquo;s dependencies
managing feature to resolve the path for us.</p>

<figure class='code'><figcaption><span>Resolve Android Annotation processor path</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">configurations</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">apt</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">apt</span> <span class="nf">files</span><span class="o">(</span><span class="s1">&#39;compile-libs/androidannotations-2.7.1.jar&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Add dependencies</h2>

<p>For managing dependencies, Gradle uses a <code>dependencies</code> block. The following
code snippets shows different ways to include dependencies. <code>fileTree</code> can be
used to iterate files in directory, <code>string</code> will be resolved using
repositories(default includes Maven Central) and <code>project</code> is used to reference
dependent local projects. We will talk about multi-project build support later.</p>

<figure class='code'><figcaption><span>Different ways to specify dependencies</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="s1">&#39;libs&#39;</span><span class="o">,</span> <span class="nl">include:</span> <span class="s1">&#39;*.jar&#39;</span><span class="o">,</span> <span class="nl">exclude:</span> <span class="s1">&#39;android-support-v4.jar&#39;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">compile</span> <span class="s1">&#39;com.android.support:support-v4:18.0.+&#39;</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">project</span><span class="o">(</span><span class="s1">&#39;:extra:actionbarsherlock&#39;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">project</span><span class="o">(</span><span class="s1">&#39;:extra:ViewPagerIndicator&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Say if you put the Android Annotation API jar into libs directory, the build
system should picked it up by now.</p>

<h2>Token Replacement</h2>

<p>Sometimes we would like to have a way to reference build version, git revisions
from Java code. To accomplish this, we need to collect those informations and
put it in a Java source file which will be picked out later during compilation.</p>

<p>Let&rsquo;s say if you have a AppBuild.java looks like below and we put it in
<code>compile-libs</code> directory.</p>

<figure class='code'><figcaption><span>Template of AppBuild.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">idv</span><span class="o">.</span><span class="na">Zero</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppBuild</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GIT_REV</span> <span class="o">=</span> <span class="s">&quot;@git-rev@&quot;</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the <code>@git-rev@</code> is the token we will replace with current git revision
number each time we build the project. Now we have the template, we need to rig
it into the build system. The way I&rsquo;m doing this is by adding a generation task
per variant and setup the dependency for compiling task to be depend on this
generation task.</p>

<figure class='code'><figcaption><span>Rig token replacement into the build system</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">org.apache.tools.ant.filters.ReplaceTokens</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span><span class="o">.</span><span class="na">applicationVariants</span><span class="o">.</span><span class="na">all</span> <span class="o">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="kt">def</span> <span class="n">taskName</span> <span class="o">=</span> <span class="s2">&quot;generateAppBuild${variant.dirName.capitalize()}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="o">(</span><span class="n">taskName</span><span class="o">,</span> <span class="nl">type:</span> <span class="n">Copy</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">def</span> <span class="n">todir</span> <span class="o">=</span> <span class="s2">&quot;build/source/AppBuild/${variant.dirName}/cc/hypo/pieceroids&quot;</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">todir</span><span class="o">).</span><span class="na">mkdirs</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">from</span> <span class="n">project</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="s1">&#39;compile-libs/AppBuild.java&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">into</span> <span class="n">todir</span>
</span><span class='line'>    <span class="n">outputs</span><span class="o">.</span><span class="na">upToDateWhen</span> <span class="o">{</span> <span class="kc">false</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">def</span> <span class="n">proc</span> <span class="o">=</span> <span class="s2">&quot;git rev-parse --verify HEAD&quot;</span><span class="o">.</span><span class="na">execute</span><span class="o">()</span>
</span><span class='line'>    <span class="n">proc</span><span class="o">.</span><span class="na">waitFor</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">filter</span><span class="o">(</span><span class="n">ReplaceTokens</span><span class="o">,</span> <span class="nl">tokens:</span><span class="o">[</span><span class="s1">&#39;git-rev&#39;</span><span class="o">:</span> <span class="n">proc</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">trim</span><span class="o">()])</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">tasks</span><span class="o">[</span><span class="s2">&quot;compile${variant.dirName.capitalize()}&quot;</span><span class="o">].</span><span class="na">dependsOn</span><span class="o">(</span><span class="n">taskName</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What this code snippets do is to initiate a copy task by the name
<code>generateAppBuild${variant}</code>. Note the outputs.upToDateWhen line would cause
the task to always run, otherwise it&rsquo;ll be skipped if the source file is not
changed, which is not what we want. You&rsquo;ll also need to import ReplaceTokens
filter from our good old friend, <code>ant</code>.</p>

<h2>Multi-Projects</h2>

<p>It is very common that you might have some sub-projects that needs to be build
together. Previously, I showed that you could have <code>compile
project(':path:to:project')</code> in <code>dependencies</code> block to have it being included
during compile time. However, you need some extra setup to make it work. You
need an extra file called <code>settings.gradle</code> with those lines.</p>

<figure class='code'><figcaption><span>settings.gradle for multi-projects</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">include</span> <span class="s2">&quot;:extra:actionbarsherlock&quot;</span>
</span><span class='line'><span class="n">include</span> <span class="s2">&quot;:extra:ViewPagerIndicator&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This indicates you have two sub-projects, they&rsquo;re located at
<code>${project.root}/extra/actionbarsherlock</code> and
<code>${project.root}/extra/ViewPagerIndicator</code>. Gradle will look for build.gradle
inside those directories and set up project dependencies automatically.</p>

<h2>Conclusion</h2>

<p>In this article, I showed how to migrate your android project to utilize Gradle
as the build system. Additionally, I also showed a way to integrate
Android Annotations and build information generation. I hope these would be
enough to get your started with Gradle. Here is the final build.gradle you
should have after all these extra codes.</p>

<figure class='code'><figcaption><span>Final build.gradle</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">org.apache.tools.ant.filters.ReplaceTokens</span>
</span><span class='line'>
</span><span class='line'><span class="n">buildscript</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">repositories</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mavenCentral</span><span class="o">()</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">classpath</span> <span class="s1">&#39;com.android.tools.build:gradle:0.5.6&#39;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">&#39;android&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">configurations</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">apt</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="s1">&#39;libs&#39;</span><span class="o">,</span> <span class="nl">include:</span> <span class="s1">&#39;*.jar&#39;</span><span class="o">,</span> <span class="nl">exclude:</span> <span class="s1">&#39;android-support-v4.jar&#39;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">compile</span> <span class="s1">&#39;com.android.support:support-v4:18.0.+&#39;</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">project</span><span class="o">(</span><span class="s1">&#39;:extra:actionbarsherlock&#39;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">project</span><span class="o">(</span><span class="s1">&#39;:extra:ViewPagerIndicator&#39;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">apt</span> <span class="nf">files</span><span class="o">(</span><span class="s1">&#39;compile-libs/androidannotations-2.7.1.jar&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="nf">getSourceSetName</span><span class="o">(</span><span class="n">variant</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">variant</span><span class="o">.</span><span class="na">dirName</span><span class="o">).</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span><span class="o">.</span><span class="na">applicationVariants</span><span class="o">.</span><span class="na">all</span> <span class="o">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="kt">def</span> <span class="n">aptOutputDir</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="s2">&quot;build/source/apt&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kt">def</span> <span class="n">aptOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">aptOutputDir</span><span class="o">,</span> <span class="n">variant</span><span class="o">.</span><span class="na">dirName</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">android</span><span class="o">.</span><span class="na">sourceSets</span><span class="o">[</span><span class="n">getSourceSetName</span><span class="o">(</span><span class="n">variant</span><span class="o">)].</span><span class="na">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="n">aptOutput</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">options</span><span class="o">.</span><span class="na">compilerArgs</span> <span class="o">+=</span> <span class="o">[</span>
</span><span class='line'>    <span class="s1">&#39;-processorpath&#39;</span><span class="o">,</span> <span class="n">configurations</span><span class="o">.</span><span class="na">apt</span><span class="o">.</span><span class="na">getAsPath</span><span class="o">(),</span>
</span><span class='line'>    <span class="s1">&#39;-s&#39;</span><span class="o">,</span> <span class="n">aptOutput</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">source</span><span class="o">.</span><span class="na">filter</span> <span class="o">{</span> <span class="n">p</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">aptOutputDir</span><span class="o">.</span><span class="na">getPath</span><span class="o">())</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">variant</span><span class="o">.</span><span class="na">javaCompile</span><span class="o">.</span><span class="na">doFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">aptOutput</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">()</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">android</span><span class="o">.</span><span class="na">sourceSets</span><span class="o">[</span><span class="n">getSourceSetName</span><span class="o">(</span><span class="n">variant</span><span class="o">)].</span><span class="na">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="s2">&quot;build/source/AppBuild/${variant.dirName}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="n">taskName</span> <span class="o">=</span> <span class="s2">&quot;generateAppBuild${variant.dirName.capitalize()}&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="o">(</span><span class="n">taskName</span><span class="o">,</span> <span class="nl">type:</span> <span class="n">Copy</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">def</span> <span class="n">todir</span> <span class="o">=</span> <span class="s2">&quot;build/source/AppBuild/${variant.dirName}/cc/hypo/pieceroids&quot;</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">todir</span><span class="o">).</span><span class="na">mkdirs</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">from</span> <span class="n">project</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="s1">&#39;compile-libs/AppBuild.java&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">into</span> <span class="n">todir</span>
</span><span class='line'>    <span class="n">outputs</span><span class="o">.</span><span class="na">upToDateWhen</span> <span class="o">{</span> <span class="kc">false</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">def</span> <span class="n">proc</span> <span class="o">=</span> <span class="s2">&quot;git rev-parse --verify HEAD&quot;</span><span class="o">.</span><span class="na">execute</span><span class="o">()</span>
</span><span class='line'>    <span class="n">proc</span><span class="o">.</span><span class="na">waitFor</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">filter</span><span class="o">(</span><span class="n">ReplaceTokens</span><span class="o">,</span> <span class="nl">tokens:</span><span class="o">[</span><span class="s1">&#39;git-rev&#39;</span><span class="o">:</span> <span class="n">proc</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">trim</span><span class="o">()])</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">tasks</span><span class="o">[</span><span class="s2">&quot;compile${variant.dirName.capitalize()}&quot;</span><span class="o">].</span><span class="na">dependsOn</span><span class="o">(</span><span class="n">taskName</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">compileSdkVersion</span> <span class="mi">15</span>
</span><span class='line'>  <span class="n">buildToolsVersion</span> <span class="s2">&quot;17&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sourceSets</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">main</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">manifest</span><span class="o">.</span><span class="na">srcFile</span> <span class="s1">&#39;AndroidManifest.xml&#39;</span>
</span><span class='line'>        <span class="n">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;src&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">res</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;res&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/24/two-factor-authentication-for-windows/" title="Previous Post: Two-factor Authentication for Windows">&laquo; Two-factor Authentication for Windows</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/03/03/introduction-to-twitters-zipkin/" title="Next Post: Introduction to Twitter's Zipkin">Introduction to Twitter's Zipkin &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <footer role="contentinfo"><!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '50b5b9ea613f5d69b1000004');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

<script type="text/javascript" src="//use.typekit.net/kmk5zau.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zerogithub';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://itszero.github.com/blog/2013/09/13/migrate-android-project-to-gradle/';
        var disqus_url = 'http://itszero.github.com/blog/2013/09/13/migrate-android-project-to-gradle/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>
